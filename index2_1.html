<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
    <title>想把我唱给你听</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/animate.css">
</head>

<body>
    <audio hidden></audio>
    <div id="container">
        <h1>&nbsp;<span></span>&nbsp;</h1>
        <div class="picker">
            <div class="imger"></div>
            <div class="imger-mask"></div>
        </div>
        <div id="ulcontainer" class="woah shaker">
            <ul></ul>
        </div>
        <footer>
            <div class="foot">
                <span class="btn forward back" id="back"></span>
                <span class="btn start" id="start"></span>
                <span class="btn forward" id="forward"></span>
            </div>
        </footer>
    </div>
    <div class="mask-container">
        <div class="mask">
            <span>正在加载</span>
            <dot>...</dot>
        </div>
    </div>
    <div class="imgblur"></div>
    <div class="words">
        <ul class="sayword"></ul>
    </div>
    <img src="img/min/img1.jpg" alt="" style="display: none">
    <img data-src="img/min/img2.jpg" alt="" style="display: none">
    <img data-src="img/min/img3.jpg" alt="" style="display: none">
    <img data-src="img/min/img4.jpg" alt="" style="display: none">
    <img data-src="img/min/img5.jpg" alt="" style="display: none">
    <script src="js/zepto.min.js"></script>
    <script src="js/deferred.js"></script>
    <script src="js/callback.js"></script>
    <script src="js/touch.js"></script>
    <script src="js/event.js"></script>
    <script src="js/wx.js"></script>
    <script src="js/typed.js"></script>
    <script src="js/sweetalert.min.js"></script>
    <script>
    var audio, lyricContainer, lyric, words, typed, xx = 0;
    var title = document.querySelector('h1>span');
    var mask = document.querySelector('.mask-container');
    lyricContainer = document.querySelector('#container');
    var picker = document.querySelector('.picker');
    var imger = document.querySelector('.imger');
    var imgblur = document.querySelector('.imgblur');
    var wordser = document.querySelector('.words');
    var back = $('#back');
    var play = $('#start')[0] == undefined ? $('.play') : $('#start');
    var forward = $('#forward');
    var flag = true;
    var isWX = false;
    var isSay = false;
    var isSayOk = true;
    var songIds = ['29431066', '27646198', '254574', '490602750', '202373', '35476049'];
    var animations = ['bounceInLeft', 'fadeInLeft', 'rotateIn', 'rotateInDownLeft', 'slideInLeft', 'zoomInLeft', 'zoomInUp', 'flipInX', 'flipInY'];

    window.onload = function() {
        mask.style.display = "none"; //loading 动画隐藏
        /*微信浏览器处理*/
        var ua = window.navigator.userAgent.toLowerCase();
        var isIos = /(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent);
        if (ua.match(/MicroMessenger/i) == 'micromessenger') {
            flag = false ;
            isWX = true;
        }

        audio = document.querySelector('audio'); //获取页面上的audio标签
        init();
        loadImages(); //加载预留图片

        audio.ontimeupdate = function(e) {
            for (var i = 0, l = lyric.length; i < l; i++) {
                if (parseInt(this.currentTime) == parseInt(lyric[i][0])) {
                    $('ul li').removeClass('actived');
                    var li = $('ul li').eq(i);
                    li.addClass('actived');
                    if (i > 5) {
                        $('ul li').get(0).style.marginTop = -(i - 5) * 2 + 'em';
                    }
                };
            };
        };
        audio.addEventListener('canplay', function() {
            if (isWX) return;
            setTimeout(function() {
                imger.classList.add('ani');
                play.removeClass('start').addClass('play');
                audio.play();
            }, 400)
        });
        audio.addEventListener('ended', turnSong); //播放结束自动切换

        $.ajax({
            url: './js/words.txt',
            type: 'GET',
            dataType: 'application/text'
        })
        .done(function(data){
            words = data.split('\n');
        })
        .fail(function(){
            console.log('error');
        })

    }

    function parseLyric(text) {
        //将文本分隔成一行一行，存入数组
        var lines = text.split('\n'),
            //用于匹配时间的正则表达式，匹配的结果类似[xx:xx.xx]
            pattern = /\[\d{2}:\d{2}.\d{2,4}\]/g,
            pattern2 = /[\u4e00-\u9fa5]+/g,
            //保存最终结果的数组
            result = [];
        //去掉不含时间的行
        while (!pattern.test(lines[0])) {
            lines = lines.slice(1);
        };
        //上面用'\n'生成生成数组时，结果中最后一个为空元素，这里将去掉  
        lines[lines.length - 1].length === 0 && lines.pop();
        lines.forEach(function(v, i, a) {
            //提取出时间[xx:xx.xx]
            var time = v.match(pattern),
                //提取歌词
                value = v.replace(pattern, '');
            //因为一行里面可能有多个时间，所以time有可能是[xx:xx.xx][xx:xx.xx][xx:xx.xx]的形式，需要进一步分隔
            time.forEach(function(v1, i1, a1) {
                //去掉时间里的中括号得到xx:xx.xx
                var t = v1.slice(1, -1).split(':');
                //将结果压入最终数组
                result.push([parseInt(t[0], 10) * 60 + parseFloat(t[1]), value]);
            });
        });
        //最后将结果数组中的元素按时间大小排序，以便保存之后正常显示歌词
        result.sort(function(a, b) {
            return a[0] - b[0];
        });
        lyric = result;
        return result;
    }

    function getLrc(id) {
        var request = {
            type: 'lyric',
            id: id
        };
        $.get('https://api.imjad.cn/cloudmusic/', request, function(data) {
            parseLyric(data.lrc.lyric);
            var ul = document.createElement('ul');
            lyric.forEach(function(e, i) {
                var li = document.createElement('li');
                li.innerHTML = e[1]+"&nbsp;";
                ul.appendChild(li);
            })
            document.querySelector('#ulcontainer').innerHTML = '';
            document.querySelector('#ulcontainer').appendChild(ul);
        })

        /*引入zepto defferd 需单独引入 还需callback 配合*/
        
    }

    function getTitle(id) {
        var request = {
            type: 'detail',
            id: id
        };
        $.get('https://api.imjad.cn/cloudmusic/', request, function(data) {
            title.textContent = data.songs[0].name
        })
    }

    function parseAudioSrc(id) {
        return 'http://music.163.com/song/media/outer/url?id=' + id + '.mp3';
    }

    function loadImages() {
        let images = document.querySelectorAll('img+img');
        Array.prototype.forEach.call(images, function(el, i) {
            var imgSrc = el.getAttribute('data-src');
            el.src = imgSrc;
        })
    }

    function turnSong() {
        forward.trigger('tap');
    }

    function sayWords(data){
        var _data = data;
        // var rad1 = parseInt(Math.random()*words.length); //随机产生words下标
        // var rad2 = parseInt(Math.random()*animations.length); //随机产生animations下标

        // var ul = document.querySelector('.words ul');
        // var li = '<li class=\'animated '+animations[rad2]+'\'>'+words[rad1]+'</li>';
        // ul.insertAdjacentHTML('afterbegin',li);

        // var liLen = ul.querySelectorAll('li').length;
        // var currentLi = ul.querySelector('li');

        // currentLi.addEventListener('animationend',function(){
        //     if ( liLen >= 3 ) {
        //         var lastLi = ul.querySelector('li:last-child');
        //         currentLi.parentNode.removeChild(lastLi);
        //     }
        //     sayWords(_data);
        // })

        var liArr = '';
        data.forEach(function(e,i){
            liArr+= '<li>'+e+'</li>^400';
        })
        var ani = setInterval(scrollWords,55); //number: 滚动速度
        typed = new Typed(".sayword", {
            strings: [liArr],
            startDelay: 1000,
            typeSpeed: 20, //打字速度
            contentType: 'html',
            onComplete: function(self){
                console.log('words is complete output');
                isSayOk = false ;
                (function(i){
                    setTimeout(function(){
                        clearInterval(i); //延迟清除定时器 防止过早清除而滚动未结束
                        swal({
                            title: "XX同学(标题)",
                            text: "路途遥远 我们在一起吧!(这里是你要说的话)",
                            icon: "img/img1.jpg",
                            buttons: ['残忍拒绝','咱俩没戏'],
                            dangerMode: true,
                        })
                        .then((willDelete) => {
                            if (willDelete) {
                                swal("不存在的!", {
                                    icon: "success",
                                });
                                wordser.innerHTML = '';
                            } else {
                                swal("那是不可能的!");
                                wordser.innerHTML = '';
                            }
                        });
                    },20000)
                })(ani)
            }
        })
    }

    function scrollWords(xxx){
        wordser.scrollTo(0,xx);
        xx++;
    }

    forward.tap(function(){
        if (isSay && isSayOk) {
            alert('故事还要继续');
            return ;
        }
        imger.classList.remove('ani');
        var imgUrl = window.getComputedStyle(imger).backgroundImage;
        var ptn = /(\w)+\.jpg/g;
        var arr = ptn.exec(imgUrl);
        var imgName = arr[0];
        var imgNum = imgName.split('.')[0].split('img')[1];
        if (imgNum == 5) imgNum = 0;
        imgNum++;
        imger.style.backgroundImage = 'url(./img/min/img' + imgNum + '.jpg)';
        imgblur.style.backgroundImage = 'url(./img/min/img' + imgNum + '.jpg)';
        init();
        if (isWX) {
            setTimeout(function() {
                imger.classList.add('ani');
                autoPlayAudio();
            }, 400)
        }
    })

    back.tap(function(){
        if (isSay && isSayOk) {
            alert('往事不必回首');
            return ;
        }
        imger.classList.remove('ani');
        var imgUrl = window.getComputedStyle(imger).backgroundImage;
        var ptn = /(\w)+\.jpg|png|jpeg|gif/g;
        var arr = ptn.exec(imgUrl);
        var imgName = arr[0];
        var imgNum = imgName.split('.')[0].split('img')[1];
        if (imgNum == 1) imgNum = 5;
        imgNum--;
        imger.style.backgroundImage = 'url(./img/min/img' + imgNum + '.jpg)';
        imgblur.style.backgroundImage = 'url(./img/min/img' + imgNum + '.jpg)';
        init();
        if (isWX) {
            setTimeout(function() {
                imger.classList.add('ani');
                autoPlayAudio();
            }, 400)
        }
    })

    play.tap(function(e) {
        if (flag) {
            flag = !flag;
            audio.pause();
            if (isSay) {
                typed.stop();
            }
            var iTransform = getComputedStyle(imger).transform;
            var cTransform = getComputedStyle(picker).transform;
            picker.style.transform = cTransform === 'none' ? iTransform : iTransform.concat(' ', cTransform);
            imger.classList.remove('ani');
            play.removeClass('play').addClass('start');
        } else {
            flag = !flag;
            imger.classList.add('ani');
            audio.play();
            if (isSay) {
                typed.start();
            }
            play.removeClass('start').addClass('play');
        }
        if (isSay) return;
        sayWords(words);
        isSay = true;
    })

    function init() {
        let rad = parseInt(Math.random() * songIds.length);
        audio.src = parseAudioSrc(songIds[rad]);
        getTitle(songIds[rad]);
        getLrc(songIds[rad]);
    }

    /* for weixin */
    function autoPlayAudio() {
        wx.config({
            // 配置信息, 即使不正确也能使用 wx.ready
            debug: false,
            appId: '',
            timestamp: 1,
            nonceStr: '',
            signature: '',
            jsApiList: []   
        });
        wx.ready(function() {
            audio.play();
        });
    }

    /* for PC */
    if(!/Android|webOS|iPhone|iPad|BlackBerry/i.test(navigator.userAgent)) {
        $('footer').on('click','span',function(){
            var id = this.id;
            if (id == 'forward') {
                forward.trigger('tap');
            }
            if (id == 'start') {
                play.trigger('tap');
            }
            if (id == 'back') {
                back.trigger('tap');
            }
        })
        document.querySelector('#ulcontainer').style.overflow = 'hidden'
    }

    </script>
</body>

</html>